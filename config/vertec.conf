
dataObjects {

  Abwesenheiten = ${default.inputspektra}
  Leistungen = ${default.inputspektra}
  Sollzeiten = ${default.inputspektra}

  //stg
  stg_vertec_Abwesenheiten = ${default.Stage}
  stg_tmp_vertec_Abwesenheiten = ${default.StageTmp}{ partitions = ["jahr"] }

  stg_vertec_Leistungen = ${default.Stage}
  stg_tmp_vertec_Leistungen    = ${default.StageTmp}{ partitions = ["jahr"] }

  stg_vertec_Sollzeiten = ${default.Stage}
  stg_tmp_vertec_Sollzeiten    = ${default.StageTmp}{ partitions = ["jahr"] }

  //int
  int_vertec_Abwesenheiten = ${default.Int} { path = "Abwesenheiten/", partitions = ["jahr"] }
  int_vertec_Leistungen = ${default.Int} {    path = "Leistungen/",    partitions = ["jahr"] }
  int_vertec_Sollzeiten = ${default.Int} {    path = "Sollzeiten/",    partitions = ["jahr"] }

  //btl
  btl_vertec_Abwesenheiten = ${default.Btl} { path = "Abwesenheiten/", partitions = ["jahr"] }
  btl_vertec_Leistungen = ${default.Btl} {    path = "Leistungen/",    partitions = ["jahr"] }
  btl_vertec_Sollzeiten = ${default.Btl} {    path = "Sollzeiten/",    partitions = ["jahr"] }
}

actions {
  // stg
  stg_vertec_Abwesenheiten {
    type = CopyAction
    inputId = Abwesenheiten
    outputId = stg_vertec_Abwesenheiten
    metadata {
      feed = stg_vertec_Abwesenheiten
    }
  }
  stg_vertec_Leistungen {
    type = CopyAction
    inputId = Leistungen
    outputId = stg_vertec_Leistungen
    metadata {
      feed = stg_vertec_Leistungen
    }
  }
  stg_vertec_Sollzeiten {
    type = CopyAction
    inputId = Sollzeiten
    outputId = stg_vertec_Sollzeiten
    metadata {
      feed = stg_vertec_Sollzeiten
    }
  }

  // introduce year partitions
  stg_tmp_vertec_Abwesenheiten {
    type = CopyAction
    inputId = stg_vertec_Abwesenheiten
    outputId = stg_tmp_vertec_Abwesenheiten

    transformers = [{
      type = SQLDfTransformer
      code = """select year(TO_DATE(CAST(UNIX_TIMESTAMP(datum, 'dd.MM.yyyy') AS TIMESTAMP))) as jahr,
                * from stg_vertec_Abwesenheiten""" }]

    metadata { feed = stg_vertec_Abwesenheiten }
  }

  stg_tmp_vertec_Leistungen {
    type = CopyAction
    inputId = stg_vertec_Leistungen
    outputId = stg_tmp_vertec_Leistungen

    transformers = [{
      type = SQLDfTransformer
      code = """select year(TO_DATE(CAST(UNIX_TIMESTAMP(datum, 'dd.MM.yyyy') AS TIMESTAMP))) as jahr,
                * from stg_vertec_Leistungen""" }]

    metadata { feed = stg_vertec_Leistungen }
  }

  stg_tmp_vertec_Sollzeiten {
    type = CopyAction
    inputId = stg_vertec_Sollzeiten
    outputId = stg_tmp_vertec_Sollzeiten

    transformers = [{
      type = SQLDfTransformer
      code = """select year(TO_DATE(CAST(UNIX_TIMESTAMP(datum, 'dd.MM.yyyy') AS TIMESTAMP))) as jahr,
                * from stg_vertec_Sollzeiten""" }]

    metadata { feed = stg_vertec_Sollzeiten }
  }

  //int
  int_vertec_Abwesenheiten {
    type = CopyAction
    inputId = stg_tmp_vertec_Abwesenheiten
    outputId = int_vertec_Abwesenheiten
    metadata {
      feed = int_vertec_Abwesenheiten
    }
    executionMode {
        type = CustomPartitionMode
        className = ch.gvb.ProcessAllIncomingPartitions
    }
  }

  int_vertec_Leistungen {
    type = CopyAction
    inputId = stg_tmp_vertec_Leistungen
    outputId = int_vertec_Leistungen
    metadata {
      feed = int_vertec_Leistungen
    }
    executionMode {
        type = CustomPartitionMode
        className = ch.gvb.ProcessAllIncomingPartitions
    }
  }
  int_vertec_Sollzeiten {
    type = CopyAction
    inputId = stg_tmp_vertec_Sollzeiten
    outputId = int_vertec_Sollzeiten
    metadata {
      feed = int_vertec_Sollzeiten
    }
    executionMode {
        type = CustomPartitionMode
        className = ch.gvb.ProcessAllIncomingPartitions
    }
  }

  //btl
  btl_vertec_Abwesenheiten {
    type = CopyAction
    inputId = int_vertec_Abwesenheiten
    outputId = btl_vertec_Abwesenheiten
    metadata {
      feed = btl_vertec_Abwesenheiten
    }
  }
  btl_vertec_Leistungen {
    type = CopyAction
    inputId = int_vertec_Leistungen
    outputId = btl_vertec_Leistungen
    metadata {
      feed = btl_vertec_Leistungen
    }
  }
  btl_vertec_Sollzeiten {
    type = CopyAction
    inputId = int_vertec_Sollzeiten
    outputId = btl_vertec_Sollzeiten
    metadata {
      feed = btl_vertec_Sollzeiten
    }
  }
}
